#!/bin/bash

MAILADDRESS="`whoami`@theory.phy.tu-dresden.de"
LOGFILE="sherpa_benchmarking"
STATUS="Benchmarking report: "
DATE=`date +'%y-%m-%d'`
CVSROOT=":ext:141.30.17.250:/usr/local/cvsroot"
CVS_RSH="ssh"
ROOTSYS="/usr/local/root"
CLHEPSYS="/usr/local/CLHEP"
CLHEPDIR="/usr/local/CLHEP"
COMPILECOMMAND="TOOLS/makeinstall --clean-run -t --clean --cxx -g --cxx -O2"
DIR="BENCHMARK"
FILE="Benchmark.dat"
SHERPAPATH="SHERPA-1.0/Run/"
MEHANDLEREXIT=201

SetStatus() {
  STATUS=$STATUS$1
}

SendMail() {
  echo -e "\nbenchmark: for details consider\n\n           '$PWD/$OUTPUTFILE'\n" >> $LOGFILE
  if [ "$IO_ERROR" = "TRUE" ] ; then SetStatus "IO error " 
  elif [ "$CVS_ERROR" = "TRUE" ] ; then SetStatus "CVS error " 
  elif [ "$COMPILE_ERROR" = "TRUE" ] ; then SetStatus "Compile error " 
  elif [ "$SETUP_ERROR" = "TRUE" ] ; then SetStatus "Setup error " 
  elif [ "$RUNTIME_ERROR" = "TRUE" ] ; then SetStatus "Runtime error " 
  elif [ "$BENCHMARK_ERROR" = "TRUE" ] ; then SetStatus "Benchmark error " 
  else 
   SetStatus "Benchmarking succeeded "
   exit 0 
  fi
  nail -s "$STATUS" $MAILADDRESS < $LOGFILE
  exit $1
}

CleanUp() {
  for I in $1 ; do
    if [ -d $I ] ; then
      rm -rf $I/* > /dev/null 2>&1
    else
      rm -f $I > /dev/null 2>&1
    fi
  done
}

GetList() {
  while read ITEM ; do
    LIST=$LIST" "$ITEM
  done
}

GetFiles() {
  while read I ; do
    BENCHMARK=$BENCHMARK" "$I
  done
}

export CVSROOT
export CVS_RSH
export ROOTSYS
export CLHEPSYS
export CLHEPDIR

for I in $* ; do
  if [ "$I" = "-p" ]; then DDIR=TRUE
  elif [ "$I" = "-f" ]; then DFILE=TRUE
  elif [ "$I" = "-l" ]; then DLOGFILE=TRUE
  elif [ "$I" = "-m" ]; then DMAILADDRESS=TRUE
  elif [ "$I" = "-u" ]; then UPDATE=TRUE
  elif [ "$I" = "-h" ]; then echo && \
    echo "benchmark version 1.0" && echo && \
    echo "options: -p <path>      specifiy benchmark points in path <path>" && \
    echo "         -f <file>      specifiy benchmark points in file <file>" && \
    echo "         -l <logfile>   write benchmarking output to <logfile>" && \
    echo "         -m <address>   send benchmarking report to <address>" && \
    echo "         -u             update from cvs before benchmarking" && \
    echo "         -h             display this help and exit" && echo && \
    exit 0
  elif [ "$DDIR" = "TRUE" ]; then DDIR="" && DIR=$I
  elif [ "$DFILE" = "TRUE" ]; then DFILE="" && FILE=$I
  elif [ "$DLOGFILE" = "TRUE" ]; then DLOGFILE="" && LOGFILE=$I
  elif [ "$DMAILADDRESS" = "TRUE" ]; then DMAILADDRESS="" && MAILADDRESS=$I
  else echo "benchmark: error: unrecognized option '$I'. try '-h'" && \
    exit 1 
  fi
done

LOGFILE=$LOGFILE"_"$DATE
OUTPUTFILE=$LOGFILE"_full_output"
echo "" > $LOGFILE
echo "" > $OUTPUTFILE

echo -e "benchmark: benchmarking started at '$HOSTNAME' ($HOSTTYPE) on `date`\n" >> $LOGFILE
echo -e "benchmark: benchmarking started at '$HOSTNAME' ($HOSTTYPE) on `date`\n" >> $OUTPUTFILE
LIST=""

rm -rf $DIR
echo -en "checking out current benchmarking points from cvs ... " >> $LOGFILE
echo -e "checking out current benchmarking points from cvs {\n" >> $OUTPUTFILE
if ! cvs co benchmark >> $OUTPUTFILE 2>&1 ; then
  echo -e "checkout failed\n\nbenchmark: cvs checkout failed" >> $LOGFILE
  echo -e "\n} checkout failed\n\nbenchmark: cvs checkout failed" >> $OUTPUTFILE
  CVS_ERROR=TRUE
  SendMail 1
else 
  echo -e "finished" >> $LOGFILE
  echo -e "\n} finished checkout\n" >> $OUTPUTFILE
fi
if [ -f $DIR/$FILE ] ; then
  GetList < $DIR/$FILE
else
  echo -e "benchmark: reading from input file '$FILE' failed" >> $LOGFILE
  echo -e "benchmark: reading from input file '$FILE' failed\n" >> $OUTPUTFILE
  IO_ERROR=TRUE
  SendMail 1
fi

if [ "$UPDATE" = "TRUE" ] ; then
  echo -en "updating current sherpa version from cvs ... " >> $LOGFILE
  echo -e "updating current sherpa version from cvs {\n" >> $OUTPUTFILE
  if ! cvs update -d >> $OUTPUTFILE 2>&1 ; then
    echo -e "update failed\n\nbenchmark: cvs update failed" >> $LOGFILE
    echo -e "\n} update failed\n\nbenchmark: cvs update failed" >> $OUTPUTFILE
    CVS_ERROR=TRUE
    SendMail 2
  else 
    echo -e "finished" >> $LOGFILE
    echo -e "\n} finished update\n" >> $OUTPUTFILE
  fi
fi

echo -en "compiling current sherpa version via '$COMPILECOMMAND' ... " >> $LOGFILE
echo -e "compiling current sherpa version via '$COMPILECOMMAND' {\n" >> $OUTPUTFILE
if ! $COMPILECOMMAND >> $OUTPUTFILE 2>&1 ; then
  echo -e "failed\n\nbenchmark: compilation failed" >> $LOGFILE
  echo -e "\n} compilation failed\n\nbenchmark: compilation failed" >> $OUTPUTFILE
  COMPILE_ERROR=TRUE
  SendMail 3
else 
  WARNINGS=`cat $OUTPUTFILE | grep warning | wc -l`
  if (( $WARNINGS != 0 )) ; then
    echo -e "finished with $WARNINGS warnings" >> $LOGFILE
  else
    echo -e "finished" >> $LOGFILE
  fi
  echo -e "\n} finished compilation with $WARNINGS warnings\n" >> $OUTPUTFILE
fi

MAINPATH=$PWD
for I in $LIST ; do
  CURRENT_BENCHMARK_ERROR=""
  if [ ! -d $DIR/$I ] ; then
    echo "benchmark: setup directory '$I' is missing" >> $LOGFILE
    echo "benchmark: setup directory '$I' is missing" >> $OUTPUTFILE
    SETUP_ERROR=TRUE
  else
    echo -en "benchmark: benchmarking in '$I' ... " >> $LOGFILE
    echo -e "benchmark: benchmarking in '$I' {\n" >> $OUTPUTFILE
    cd $DIR/$I
    BENCHMARK=""
    if [ -f $FILE ] ; then
      GetFiles < $FILE
    else
      echo -e "benchmark: no benchmarking points specified in '$PWD'" >> $OUTPUTFILE
      SETUP_ERROR=TRUE
    fi
    CleanUp "Results Analysis Output"
    RUNPATH=$PWD
    cd $MAINPATH/$SHERPAPATH
    ./makeclean >> $MAINPATH/$OUTPUTFILE 2>&1
    ./Sherpa PRETTY_PRINT=Off PATH=$RUNPATH ANALYSIS_OUTPUT=$RUNPATH"/" \
	   RESULT_DIRECTORY=$RUNPATH"/Results/" >> $MAINPATH/$OUTPUTFILE 2>&1
    while (( $? == $MEHANDLEREXIT )) ; do
      ./makelibs >> $MAINPATH/$OUTPUTFILE 2>&1
      ./Sherpa PRETTY_PRINT=Off PATH=$RUNPATH ANALYSIS_OUTPUT=$RUNPATH"/" \
             RESULT_DIRECTORY=$RUNPATH"/Results/" >> $MAINPATH/$OUTPUTFILE 2>&1
    done 
    if (( $? != 0 )) ; then
      RUNTIME_ERROR=TRUE
    fi
    cd $RUNPATH
    COUNTER=0
    for I in $BENCHMARK ; do
      (( ++COUNTER ))
      if (( $COUNTER%2 == 0 )) ; then 
        NEW=$I 
	diff -cb $NEW $OLD >> $MAINPATH/$OUTPUTFILE 2>&1
	if (( $? != 0 )) ; then
	  BENCHMARK_ERROR=TRUE
	  CURRENT_BENCHMARK_ERROR=TRUE
	fi
      elif (( $COUNTER%2 == 1 )) ; then 
        OLD=$I
      else 
        echo -n
      fi
    done
    cd $MAINPATH
    if [ "$CURRENT_BENCHMARK_ERROR" != "TRUE" ] ; then
      echo -e "finished" >> $LOGFILE
    else 
      echo -e "failed" >> $LOGFILE
    fi
    echo -e "\n} benchmarking finished \n" >> $OUTPUTFILE
  fi
done

SendMail 4

# mode:shell-script
# sh-indentation:2
