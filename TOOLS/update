#!/bin/bash

NOUPDATE="TRUE"
TEMPFILE="#update#"

EXTENSIONS="\.C \.cpp \.cc \.f"
EXTENSIONS=$EXTENSIONS" \.H \.hpp \.hh"
EXTENSIONS=$EXTENSIONS" \.am configure\.in" 
EXTENSIONS=$EXTENSIONS" \.trf \.man \.texi \.info"
DESCRIPTIONS="C-Files cpp-Files cc-Files f-Files"
DESCRIPTIONS=$DESCRIPTIONS" H-Files hpp-Files hh-Files"
DESCRIPTIONS=$DESCRIPTIONS" Makefiles configures"
DESCRIPTIONS=$DESCRIPTIONS" Manpages Manpages TeXinfos TeXinfos"
COLOURS="4 4 4 4 2 2 2 1 1 6 6 6 6"

OPTIONS=
LOGFILE="#updated-source#"
for I in $* ; do
  if [ "$I" = "-n" ]; then NOUPDATE=TRUE 
  elif [ "$I" = "-f" ]; then NOUPDATE=
  elif [ "$I" = "-s" ]; then STATISTICS=TRUE
  elif [ "$I" = "-l" ]; then DLOGFILE=TRUE && CLOGFILE=TRUE
  elif [ "$I" = "-h" ]; then echo && \
    echo "update version 1.0" && echo && \
    echo "options: -n             run 'cvs -n update <options>'" && \
    echo "         -f             run 'cvs update <options>'" && \
    echo "         -s             show statistics'" && \
    echo "         -l <logfile>   create logfile <logfile>" && \
    echo "         -h             display this help and exit" && \
    echo "         <any other>    passed directly to 'cvs update'" && echo && \
    exit 0
  elif [ "$DLOGFILE" = "TRUE" ]; then DLOGFILE="" && LOGFILE=$I
  else OPTIONS=$OPTIONS" "$I
  fi
done

if [ "$NOUPDATE" = "TRUE" ] ; then 
  cvs -n update $OPTIONS > $LOGFILE 2>&1
else 
  cvs update $OPTIONS > $LOGFILE 2>&1
fi

CHANGES=
EXTCNT=0
TUCOUNT=0
TMCOUNT=0
TCCOUNT=0
TNCOUNT=0
TACOUNT=0
TRCOUNT=0
for EXTENSION in $EXTENSIONS ; do
  (( ++EXTCNT ))
  cat $LOGFILE | grep -q $EXTENSION 
  if (( $? != 0 )) ; then continue ; fi
  CHANGES="TRUE"
  DESCCNT=0
  for DESCRIPTION in $DESCRIPTIONS ; do
    (( ++DESCCNT ))
    if (( $DESCCNT == $EXTCNT )) ; then break ; fi
  done
  COLCNT=0
  for COLOUR in $COLOURS ; do
    (( ++COLCNT ))
    if (( $COLCNT == $EXTCNT )) ; then break ; fi
  done
  echo -en "\e[1m==================================================\e[0m"
  echo -e "\r\e[1m=\e[3"$COLOUR"m $DESCRIPTION \e[0m"
  cat $LOGFILE | grep "U " | grep $EXTENSION
  cat $LOGFILE | grep "P " | grep $EXTENSION
  cat $LOGFILE | grep "C " | grep $EXTENSION > $TEMPFILE
  if (( $? == 0 )) ; then
    echo -e "\e[1m- Conflicts --------------------------------------\e[0m" 
    cat $TEMPFILE
  fi
  COUNT=`cat $LOGFILE | grep "U " | grep $EXTENSION | wc -l`
  (( TUCOUNT = TUCOUNT + COUNT )); COUNT=0
  COUNT=`cat $LOGFILE | grep "P " | grep $EXTENSION | wc -l`
  (( TUCOUNT = TUCOUNT + COUNT )); COUNT=0
  COUNT=`cat $LOGFILE | grep "C " | grep $EXTENSION | wc -l`
  (( TCCOUNT = TCCOUNT + COUNT )); COUNT=0
  cat $LOGFILE | grep "M " | grep $EXTENSION > $TEMPFILE
  if (( $? == 0 )) ; then
    echo -e "\e[1m- Changes ----------------------------------------\e[0m" 
    cat $TEMPFILE
  fi
  COUNT=`cat $LOGFILE | grep "M " | grep $EXTENSION | wc -l`
  (( TMCOUNT = TMCOUNT + COUNT )); COUNT=0
  cat $LOGFILE | grep "erging " | grep $EXTENSION > $TEMPFILE
  if (( $? == 0 )) ; then
    echo -e "\e[1m- Merged -----------------------------------------\e[0m" 
    cat $TEMPFILE
  fi
  COUNT=`cat $LOGFILE | grep "erging " | grep $EXTENSION | wc -l`
  (( TMCOUNT = TMCOUNT + COUNT )); COUNT=0
  cat $LOGFILE | grep "? " | grep $EXTENSION > $TEMPFILE
  TEST1=$?
  cat $LOGFILE | grep "A " | grep $EXTENSION >> $TEMPFILE
  TEST2=$?
  if (( $TEST1 == 0 )) || (( $TEST2 == 0 )) ; then
    echo -e "\e[1m- New files --------------------------------------\e[0m" 
    cat $TEMPFILE
  fi
  COUNT=`cat $LOGFILE | grep "? " | grep $EXTENSION | wc -l`
  (( TNCOUNT = TNCOUNT + COUNT )); COUNT=0
  COUNT=`cat $LOGFILE | grep "A " | grep $EXTENSION | wc -l`
  (( TACOUNT = TACOUNT + COUNT )); COUNT=0
  cat $LOGFILE | grep "R " | grep $EXTENSION > $TEMPFILE
  if (( $? == 0 )) ; then
    echo -e "\e[1m- Removed files ----------------------------------\e[0m" 
    cat $TEMPFILE
  fi
  COUNT=`cat $LOGFILE | grep "R " | grep $EXTENSION | wc -l`
  (( TRCOUNT = TRCOUNT + COUNT )); COUNT=0
done
if [ "$STATISTICS" = "TRUE" ] ; then
  echo -e "\e[1m==================================================\e[0m"
  echo "Updated   : $TUCOUNT"
  echo "Modified  : $TMCOUNT"
  echo "Conflicts : $TCCOUNT"
  echo "New       : $TNCOUNT"
  echo "Added     : $TACOUNT"
  echo "Removed   : $TRCOUNT"
fi
echo -e "\e[1m==================================================\e[0m"
if [ ! "$CHANGES" = "TRUE" ] ; then
  echo -e "update: no recognized changes"
  echo -e "\e[1m==================================================\e[0m"
fi

if test -f $TEMPFILE ; then rm $TEMPFILE ; fi
if [ ! "$CLOGFILE" = "TRUE" ] ; then
  rm $LOGFILE
fi

# mode:shell-script
# sh-indentation:2
