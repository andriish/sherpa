#!/bin/bash
TIME=`date`

rmr () {  
  for file in * ; do                                                          
    if [ -d $file ] ; then                                                       
      cd $file                                                                  
      rmr "$1" $2
      cd ..                                                             
    fi
  done  
  for i in $1 ; do    
    rm -f $2 $i                                                                         
  done
}                                                                               

RUNPATH=""
BINPATH=""
PDFPATH=""
RESULTS=""
ANALYSIS=""
LIBPATH="#"
SOPTIONS=""
BASENAME=""
BATCH="PBS"
BOPTIONS=""
NICE=""
for I in $* ; do
  if [ "$I" = "-p" ]; then DRUNPATH=TRUE 
  elif [ "$I" = "-b" ]; then DBINPATH=TRUE 
  elif [ "$I" = "-s" ]; then DPDFPATH=TRUE 
  elif [ "$I" = "-r" ]; then DRESULTS=TRUE 
  elif [ "$I" = "-a" ]; then DANALYSIS=TRUE 
  elif [ "$I" = "-e" ]; then DEVENTS=TRUE 
  elif [ "$I" = "-n" ]; then DBASENAME=TRUE 
  elif [ "$I" = "-l" ]; then DLIBPATH=TRUE 
  elif [ "$I" = "-o" ]; then DSOPTIONS=TRUE 
  elif [ "$I" = "-B" ]; then DBATCH=TRUE 
  elif [ "$I" = "-C" ]; then DSLOGFILE=TRUE 
  elif [ "$I" = "-O" ]; then DBOPTIONS=TRUE 
  elif [ "$I" = "-H" ]; then DHOST=TRUE
  elif [ "$I" = "-N" ]; then DNICE=TRUE
  elif [ "$I" = "-S" ]; then SUBMIT=TRUE 
  elif [ "$I" = "-R" ]; then RUN=TRUE
  elif [ "$I" = "-h" ]; then echo && \
    echo "run version 1.0" && echo && \
    echo "options: -p <path>      read configuration from path <path>" && \
    echo "         -b <binpath>   take executeable from path <binpath>" && \
    echo "         -s <pdfpath>   take pdfs from path <pdfpath>" && \
    echo "         -r <results>   write results to path <path>/<results>" && \
    echo "         -a <analysis>  write analysis output to path <path>/<analysis>" && \
    echo "         -e <events>    generate <events> events" && \
    echo "         -n <name>      set basic filename to <name>" && \
    echo "         -l <libpath>   define library path <libpath>" && \
    echo "         -o <option>    define commandline option <option>" && \
    echo "         -B <system>    select batch system <system>" && \
    echo "         -C <checkfile> write check file <checkfile>" && \
    echo "         -O <option>    define batch system option <option>" && \
    echo "         -H <host>      run job locally on <host>" && \
    echo "         -N <level>     set nice level for nohup" && \
    echo "         -S             submit job to batch system" && \
    echo "         -R             run job via nohup" && \
    echo "         -h             display this help and exit" && echo && \
    exit 0
  elif [ "$DRUNPATH" = "TRUE" ]; then DRUNPATH="" && RUNPATH=$I
  elif [ "$DBINPATH" = "TRUE" ]; then DBINPATH="" && BINPATH=$I
  elif [ "$DPDFPATH" = "TRUE" ]; then DPDFPATH="" && PDFPATH=$I
  elif [ "$DRESULTS" = "TRUE" ]; then DRESULTS="" && RESULTS=$I
  elif [ "$DANALYSIS" = "TRUE" ]; then DANALYSIS="" && ANALYSIS=$I
  elif [ "$DEVENTS" = "TRUE" ]; then DEVENTS="" && EVENTS=$I
  elif [ "$DBASENAME" = "TRUE" ]; then DBASENAME="" && BASENAME=$I
  elif [ "$DLIBPATH" = "TRUE" ]; then DLIBPATH="" && LIBPATH=$I
  elif [ "$DSOPTIONS" = "TRUE" ]; then DSOPTIONS="" && SOPTIONS=$SOPTIONS" "$I
  elif [ "$DBATCH" = "TRUE" ]; then DBATCH="" && BATCH=$I
  elif [ "$DSLOGFILE" = "TRUE" ]; then DSLOGFILE="" && SLOGFILE=$I
  elif [ "$DBOPTIONS" = "TRUE" ]; then DBOPTIONS="" && BOPTIONS=$BOPTIONS" "$I
  elif [ "$DHOST" = "TRUE" ]; then DHOST="" && RHOST=$I
  elif [ "$DNICE" = "TRUE" ]; then DNICE="" && NICE=$I
  else echo "run: error: unrecognized option '$I'. try '-h'" && \
    exit 1 
  fi
done
if [ "$BINPATH" = "" ]; then BINPATH="." ; fi
if [ "$RUNPATH" = "" ]; then RUNPATH="./" ; fi
if [ "$RESULTS" = "" ]; then RESULTS="./" ; fi
if [ "$ANALYSIS" = "" ]; then ANALYSIS="./" ; fi
if [ "$BASENAME" = "" ]; then BASENAME="job" ; fi
$BINPATH/Sherpa --version > /dev/null 2>&1
if (( $? != 0 )) ; then
  BINPATH="."
  Sherpa --version > /dev/null 2>&1
  if (( $? != 0 )) ; then
    echo "run: executeable cannot be found in '$BINPATH' and \$PATH"
    echo "run: abort"
    exit 1
  fi
fi
if ! test -d $RUNPATH ; then
  echo "run: setup directory '$RUNPATH' does not exist"
  echo "run: abort"
  exit 2
fi
if ! test -d /$LIBPATH ; then 
  if ! test -d /$RUNPATH ; then LIBPATH=$PWD"/"$RUNPATH
  else LIBPATH=$RUNPATH
  fi
fi
if [ ! "$BATCH" = "PBS" ] && [ ! "$BATCH" = "SGE" ] ; then 
  echo "run: error: invalid batch system: '$BATCH'"
  echo "run: supported batch systems are: 'PBS' / 'SGE'"
  exit 3
fi

COUNTER=0
LOGPATH=$PWD
SETUPPATH=$LOGPATH"/"$BASENAME
while test -d $SETUPPATH"_"$COUNTER ; do
  (( ++COUNTER ))
done
SETUPPATH=$SETUPPATH"_"$COUNTER
LOGFILE="run.log"
FILE=$BASENAME"_"$COUNTER".sh"

mkdir $SETUPPATH
if test -d /$LIBPATH"/Process" ; then 
  ln -s $LIBPATH"/Process" $SETUPPATH"/Process"
fi
cp -ru $RUNPATH/* $SETUPPATH >> /dev/null 2>&1
echo "" > $FILE
if [ "$SUBMIT" = "TRUE" ] ; then 
  if [ "$BATCH" = "SGE" ] ; then
    echo "#$ -j y" >> $FILE
    echo "#$ -o $SETUPPATH" >> $FILE
    echo "#$ -N $FILE.$BATCH" >> $FILE
  else
    echo "#"$BATCH" -oe" >> $FILE
    echo "#"$BATCH" -o $FILE.$BATCH" >> $FILE
    echo "#"$BATCH" -m ae" >> $FILE
  fi
  echo "" >> $FILE
  echo "RUNPATH=\"$SETUPPATH\"" >> $FILE
  echo "LOGFILE=\"$LOGFILE\"" >> $FILE
  echo "" >> $FILE
  echo "cd \$RUNPATH" >> $FILE
  echo "" >> $FILE
  echo "echo \"\" > \$LOGFILE" >> $FILE
  echo "echo \"HOSTNAME    = \$HOSTNAME\" >> \$LOGFILE" >> $FILE
  echo "echo \"HOME        = \$HOME\" >> \$LOGFILE" >> $FILE
  echo "echo \"USER        = \$USER\" >> \$LOGFILE" >> $FILE
  echo "echo \"\" >> \$LOGFILE" >> $FILE
  if [ "$BATCH" = "SGE" ] ; then
    echo "echo \"JOB_ID      = \$JOB_ID\" >> \$LOGFILE" >> $FILE
    echo "echo \"JOB_NAME    = \$JOB_NAME\" >> \$LOGFILE" >> $FILE
    echo "echo \""$BATCH"_TASK_ID = \$"$BATCH"_TASK_ID\" >> \$LOGFILE" >> $FILE
    echo "echo \"QUEUE       = \$QUEUE\" >> \$LOGFILE" >> $FILE
    echo "echo \"TMPDIR      = \$TMPDIR\" >> \$LOGFILE" >> $FILE
  else
    echo "echo \""$BATCH"_JOBID     = \$"$BATCH"_JOBID\" >> \$LOGFILE" >> $FILE
    echo "echo \""$BATCH"_JOBNAME   = \$"$BATCH"_JOBNAME\" >> \$LOGFILE" >> $FILE
    echo "echo \""$BATCH"_O_QUEUE   = \$"$BATCH"_O_QUEUE\" >> \$LOGFILE" >> $FILE
    echo "echo \""$BATCH"_O_WORKDIR = \$"$BATCH"_O_WORKDIR\" >> \$LOGFILE" >> $FILE
  fi
  echo "echo \"\" >> \$LOGFILE" >> $FILE
  echo "" >> $FILE
  echo "echo \"Submitted on "$TIME"\" >> \$LOGFILE" >> $FILE
  echo "echo \"Started on   \`date\`\" >> \$LOGFILE" >> $FILE
  echo "" >> $FILE
  echo "echo \"\" >> \$LOGFILE" >> $FILE
  echo "" >> $FILE
else
  echo "#!/bin/bash" >> $FILE
  echo "" >> $FILE
  echo "RUNPATH=$SETUPPATH" >> $FILE
  echo "LOGFILE=\$SETUPPATH\"$LOGFILE\"" >> $FILE
  echo "" >> $FILE
  echo "cd \$RUNPATH" >> $FILE
  echo "" >> $FILE
fi
if [ "$PDFPATH" != "" ] ; then
  echo -e "export SHERPA_PDF_PATH=$PDFPATH\n" >> $FILE
fi
echo "export PATH=$BINPATH:\$PATH" >> $FILE
echo "" >> $FILE

echo -en "Sherpa " >> $FILE
if [ ! "$RESULTS" = "" ] ; then echo -en "RESULT_DIRECTORY=\"$RESULTS\" " >> $FILE ; fi
if [ ! "$ANALYSIS" = "" ] ; then echo -en "ANALYSIS_OUTPUT=\"$ANALYSIS\" " >> $FILE ; fi
if [ ! "$EVENTS" = "" ] ; then echo -en "EVENTS=$EVENTS " >> $FILE ; fi
if [ ! "$SOPTIONS" = "" ] ; then echo -en "$SOPTIONS " >> $FILE ; fi
echo -e ">> \$LOGFILE 2>&1 \n\n" >> $FILE

chmod 777 $FILE
if [ "$SUBMIT" = "TRUE" ] ; then
  qsub $FILE $BOPTIONS
  mv $FILE $SETUPPATH
elif [ "$RUN" = "TRUE" ] ; then
  mv $FILE $SETUPPATH
  sync
  RCOUNTER=0
  ssh -q $RHOST exit 
  while (( $? != 0 )) && (( $RCOUNTER < 5 )) ; do
    (( ++RCOUNTER ))
    if (( RCOUNTER > 1 )) ; then
      echo "run: host '"$RHOST"' not available."
    fi
    read -p "run: where shall your job '"$BASENAME"_"$COUNTER"' be run ? " RHOST
    ssh -q $RHOST exit 
  done
  ssh -q $RHOST exit 
  if (( $? ==0 )) ; then
    if [ "$NICE" = "" ] ; then
      ( ssh $RHOST "sync && ( nohup $SETUPPATH/$FILE > /dev/null ) &" ) &
    else 
      ( ssh $RHOST "sync && ( nohup nice -$NICE $SETUPPATH/$FILE > /dev/null ) &" ) &
    fi
  else 
    echo "run: error: cannot submit job '"$BASENAME"_"$COUNTER"'"
  fi 
fi
if ! [ "$SLOGFILE" = "" ] ; then
  echo "echo -e \"\n===> $SETUPPATH <===\"" >> $SLOGFILE
  echo "tail -1 $SETUPPATH/$LOGFILE" >> $SLOGFILE
  chmod 755 $SLOGFILE
fi

# mode:shell-script
# sh-indentation:2
