#!/bin/bash

DIRS="ATOOLS-2.0 BEAM-1.0 PDF-1.0 MODEL-1.0 PHASIC++-1.0"
DIRS=$DIRS" EXTRA_XS-1.0 ADICIC++-0.0 APACIC++-2.0 AMEGIC++-2.0 AMISIC++-1.0"
DIRS=$DIRS" AHADIC++-0.0 ANALYSIS-1.0 SHERPA-1.0 COMPARE-1.0"
DISTDIR=`date +'%y-%m-%d'`

ECOPT=""
for I in $* ; do
  if [ "$I" = "-f" ]; then DISTDIR=$DISTDIR"_"`date +'%H-%M'` 
  elif [ "$I" = "-n" ]; then DNAME=TRUE
  elif [ "$I" = "-o" ]; then ONE=TRUE
  elif [ "$I" = "--clean" ]; then ALLCLEAN=TRUE 
  elif [ "$I" = "--configure" ]; then CONFIGURE=TRUE 
  elif [ "$I" = "--hide-cvs" ]; then ECOPT=$ECOPT" --disable-cvsinclude" && CONFIGURE=TRUE
  elif [ "$I" = "--total" ]; then TOTAL=TRUE && CONFIGURE=TRUE
  elif [ "$I" = "--copt" ]; then DCOPT=TRUE 
  elif [ "$I" = "--no-abort" ]; then NOABORT=TRUE
  elif [ "$I" = "-h" ]; then echo && \
    echo "makedist version 1.0 " && echo && \
    echo "options: -f             include full time information in distribution name" && \
    echo "         -n <name>      write compressed distribution to <name>.tar.gz" && \
    echo "         -o             install single module" && \
    echo "         --clean        execute 'make clean' before 'make dist'" && \
    echo "         --configure    configure before 'make dist' (enabled with '--total')" && \
    echo "         --total        rebuild 'Makefile.in's' and 'configure's' before 'make dist'" && \
    echo "         --copt         define option for 'configure'" && \
    echo "         --no-abort     ignore exit status of 'make'" && \
    echo "         -h             display this help and exit" && echo && \
    exit 0
  elif [ "$DNAME" = "TRUE" ]; then DNAME="" && DISTDIR=$I
  elif [ "$DCOPT" = "TRUE" ]; then DCOPT="" && ECOPT=$ECOPT" "$I
  else echo "makeinstall: error: unrecognized option $I" && exit 1 ;
  fi
done

if [ "$ONE" = "TRUE" ] ; then 
  echo "makeinstall: select module ( q) to quit )"
  select DIRS in $DIRS ; do
    if [ "$DIRS" != "" ] ; then 
      break
    else 
      if [ "$REPLY" = "q" ] || [ "$REPLY" = "Q" ]  ; then exit ; fi
    fi
  done
fi

echo "*************************************"
echo "*  creating distribution of SHERPA  *"
echo "*************************************"
ALL=
for I in $DIRS;
do
  if test -d $I; then
    echo "====================================="
    echo " making dist in $I"
    echo "====================================="
    ALL=$ALL" "$I.tar.gz
    cd $I 
    if [ "$TOTAL" = "TRUE" ]; then
      libtoolize --force
      aclocal
      automake -a
      autoconf
    fi
    if [ "$CONFIGURE" = "TRUE" ]; then 
      ./configure $ECOPT
    fi
    if [ "$ALLCLEAN" = "TRUE" ]; then 
      make clean 
    fi
    CONTINUE="r"
    while [ "$CONTINUE" = "r" ]; do 
      CONTINUE=""
      if ! make dist ; then 
	echo "makedist: error: \"make dist\" in $I failed"
        if [ ! "$NOABORT" = "TRUE" ]; then
          until [ "$CONTINUE" = "y" ] || [ "$CONTINUE" = "n" ] || [ "$CONTINUE" = "r" ]; do
    	    if ! read -t 300 -n 1 -p "continue anyway (y/n/r/b) ? " CONTINUE ; then
	      CONTINUE="n"
	    fi
	    echo ""
	    if [ "$CONTINUE" = "n" ]; then
              exit 1
	    elif [ "$CONTINUE" = "b" ]; then 
              bash 
	      CONTINUE="r"
	    fi
	  done
        fi
      fi
    done
    mv $I.tar.gz ../$I.tar.gz
    cd ..
  fi
done;
rm TOOLS/*~ TOOLS/\#*
tar -czvf $DISTDIR.tar.gz $ALL TOOLS
rm -rf $ALL
echo -e "\nwrote distribution to '$DISTDIR".tar.gz"'\n"
exit 0

# mode:shell-script
# sh-indentation:2

