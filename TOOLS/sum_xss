#!/bin/bash

print_help() 
{
  echo "sum_xss version 1.0" && echo && \
  echo "options: -p <path>      sum cross sections in <path>" && \
  echo "         -n <name>      sum processes with name <name>" && \
  echo "         -h             display this help and exit" && \
  echo
}

SPATH="."
SNAME="*"
while getopts :p:n:h OPT
do
  case $OPT in
  p) SPATH=$OPTARG ;; 
  n) SNAME=$OPTARG ;; 
  h) print_help && exit 0 ;;
  \?)
    shift `expr $OPTIND - 1`
    echo -n "sum_xss: error: unrecognized option "
    if [ $OPTARG != "-" ]; then echo "'-$OPTARG'. try '--help'"
    else echo "'$1'. try '--help'"
    fi
    print_help && exit 1
  esac
done

SN=`echo $SPATH/Run\.*\.dat | wc -w`
RN=`echo $SPATH/r_1/$SNAME\.xs* | awk '{ \
  if (match($1,"*")==0) print $0; }' | wc -w`
MR=`expr $SN - $RN`

if test $RN -eq 0; then 
  echo "sum_xss: no results yet"
  exit 1
fi

echo "sum_xss: $SN setups`test $MR -eq 0 ||\
  echo \", $MR results missing\"`"

awk 'BEGIN{ 
  pb=3.89379656e8;
  xs=0; err=0; ofn=""; nosort=0;
  print "sum_xss: {";
}
{ 
  if (ofn==FILENAME) nextfile;
  ofn=FILENAME;
  cpn=$1; cxs=$2*pb; cerr=$4*pb;
  xs+=cxs; err+=cerr*cerr;
  if (cxs in pns) nosort=1; 
  pns[cxs]=cpn; xss[cxs]=cxs; errs[cxs]=cerr;
  pnc[cpn]=cpn; xsc[cpn]=cxs; errc[cpn]=cerr;
}
END{
  if (!nosort) {
    n=asort(xss);
    for (i=n;i>0;--i) {
      cxs=xss[i];
      crerr=errs[cxs]/cxs*100;
      print "  proc "n-i+1": "pns[cxs]": "cxs\
        " +- ( "errs[cxs]" = "crerr" % )";
    }
  }
  else {
    for (cpn in pnc) {
      crerr=errc[cpn]/xsc[cpn]*100;
      print "  read: "cpn": "xsc[cpn]" +- ( "\
        errc[cpn]" = "crerr" % )";
    }
  }
  print "} -> \033[1msum\033[0m : \033[34m"\
    xs"\033[0m +- ( \033[31m"sqrt(err)" = "\
    sqrt(err)/xs*100" %\033[0m )";
}' $SPATH/r_1/$SNAME\.xs*
