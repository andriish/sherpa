@node Matrix Elements
@section Matrix Elements

The setup of matrix elements is covered by the `(me)' section of
the steering file or the ME data file `ME.dat', respectively.
There are no mandatory settings to be made.

The following parameters are used to steer the matrix element setup.

@menu
* ME_SIGNAL_GENERATOR::     The matrix element generator(s).
* RESULT_DIRECTORY::        The directory to store integration results.
* EVENT_GENERATION_MODE::   The event generation mode.
* SCALES::                  How to compute scales. 
* COUPLINGS::               How to evaluate couplings.
* KFACTOR::                 Whether and how to apply a K-factor.
* YUKAWA_MASSES::           Running of Yukawa couplings
* Dipole subtraction::      Parameters for calculations with dipole subtraction.
@end menu


@node ME_SIGNAL_GENERATOR
@subsection ME_SIGNAL_GENERATOR
@cindex ME_SIGNAL_GENERATOR
The list of matrix element generators to be employed during the run.
When setting up hard processes from the @option{(processes)} section of the 
input file (see @ref{Processes}), Sherpa calls these generators in order
to check whether either one is capable of generating the corresponding
matrix element. This parameter can also be set on the command line using
option @option{-m}, see @ref{Command line}.

The built-in generators are

@table @option
@item Internal
Simple matrix element library, implementing a variety of 2->2 processes.
@item Amegic
The AMEGIC++ generator published under @mycite{Krauss2001iv}
@item Comix
The @uref{http://comix.freacafe.de,,Comix} generator published under
@mycite{Gleisberg2008fv}
@end table

It is possible to employ an external matrix element generator within Sherpa.
For advice on this topic please contact the authors, @ref{Authors}.


@node RESULT_DIRECTORY
@subsection RESULT_DIRECTORY
@cindex RESULT_DIRECTORY
This parameter specifies the name of the directory
which is used by Sherpa to store integration results
and phasespace mappings. The default is @samp{Results/}.
It can also be set using the command line parameter @option{-r},
see @ref{Command line}. The directory will not be created automatically
by Sherpa, unless the command line parameter @option{-g} is set.
Its location is relative to a potentially specified input path,
see @ref{Command line}.


@node EVENT_GENERATION_MODE
@subsection EVENT_GENERATION_MODE
@cindex EVENT_GENERATION_MODE
This parameter specifies the event generation mode.
It can also be set on the command line
using option @option{-w}, see @ref{Command line}.
The three possible options are @option{Weighted} (shortcut
@option{W}), @option{Unweighted} (shortcut @option{U}) and
@option{PartiallyUnweighted} (shortcut @option{P}). For partially
unweighted events, the weight is allowed to exceed a given maximum, 
which is lower than the true maximum weight. In such cases the
event weight will exceed the otherwise constant value.


@node SCALES
@subsection SCALES
@cindex SCALES
This parameter specifies how to compute the renormalization and
factorization scale and potential additional scales.

Sherpa provides several built-in scale schemes.
The options which are currently available are

@table @option
@item VAR
Scales are specified by additional parameters in a form which is understood
by the internal interpreter, see @ref{Interpreter}. If, for example the invariant 
mass of the lepton pair in Drell-Yan production is the desired scale,
the corresponding setup reads

@verbatim
SCALES VAR{Abs2(p[2]+p[3])}
@end verbatim

Note: the square of the desired scale must be given.
 
Renormalization and factorization scales can be chosen differently.
For example in Drell-Yan + jet production one could set

@verbatim
SCALES VAR{Abs2(p[2]+p[3])}{MPerp2(p[2]+p[3])}
@end verbatim

In this case the factorization scale must be specified first.
More than two scales can be set as well to be subsequently used, e.g.
by different couplings, see @ref{COUPLINGS}.

@item FASTJET
If @uref{http://www.fastjet.fr,,FastJet} is enabled, this tag can be 
used to set a scale based on jet, rather than parton momenta. These jets 
can be defined in all possible ways allowed by FastJet with the arguments 
specified in the following way

@verbatim
SCALES FASTJET[A=antikt,PT=10,ET=0,R=0.4,M=1]{...}
@end verbatim

Thereby, @kbd{A} defines the jet algorithm, @kbd{R} sets the cone size,
and @kbd{PT} / @kbd{ET} define the minimum transverse momentum/energy
of the jets. The additional argument @kbd{M} (default 1) sets the
averaging mode. After jet finding, the jet momenta are ordered as in
FastJet. Non-QCD partons are unaffected by this procedure, i.e. their
momentum indices remain the same. The additional tags @var{MU_22} .. 
@var{MU_n2}, with @var{n} the number of strongly interacting
final state particles, hold the nodal values of the jet clustering and
the transverse momenta of the final state jets in descending order.

@item QCD
The matrix element is clustered onto a core 2->2 configuration using a
k_T-type algorithm with recombination into on-shell partons.
Scales are defined as the minimum of the largest transverse momentum
during clustering and the lowest invariant mass in the core process.

@item METS
The matrix element is clustered onto a core 2->2 configuration using a
k_T-type algorithm with recombination into on-shell particles. Their 
corresponding flavours are determined using run-time information from 
the matrix element generator.
Scales are defined as the lowest invariant mass or negative virtuality 
in the core process. For core interactions which are pure QCD processes 
scales are set to the maximum transverse mass squared of the outgoing
particles.
@sp 1
This is the default scale scheme in Sherpa, since it is employed
for truncated shower merging, see @ref{Merging ME and PS}.
However, it might be subject to changes to enable further classes
of processes for merging in the future and should therefore be seen with care.
Integration results might change slightly between different Sherpa
versions.
@sp 1
Occasionally, users might encounter the warning message
@verbatim
METS_Scale_Setter::CalculateScale(): No CSS history for '<process name>' in <percentage>% of calls. Set \hat{s}.
@end verbatim
As long as the percentage quoted here is not too high, this does not pose
a serious problem. The warning occurs when - based on the current colour
configuration and matrix element information - no suitable clustering is
found by the algorithm. In such cases the scale is set to the invariant mass
of the partonic process.

@end table

It is possible to implement a dedicated scale
scheme within Sherpa. For advice on this topic
please contact the authors, @ref{Authors}.


@subsubsection Scale schemes for NLO calculations

For next-to-leading order calculations it must be guaranteed that the scale is 
calculated separately for the real correction and the subtraction terms,
such that within the subtraction procedure the same amount is subtracted
and added back. Starting from version 1.2.2 this is the case for all 
scale setters in Sherpa. Also, the definition of the scale must be 
infrared safe w.r.t. to the radiation of an extra parton. Infrared safe 
(for QCD-NLO calculations) are:

@itemize
@item any function of momenta of NOT strongly interacting particles
@item sum of transverse quantities of all partons (e.g. H_T2)
@item any quantity refering to jets, constructed by an IR safe
jet algorithm (not implemented yet)
@end itemize

Not infrared safe are

@itemize
@item any function of momenta of specific partons
@item for processes with hadrons in the initial state: 
any quantity that depends on parton momenta along the beam axis, 
including the initial state partons itself 
@end itemize

Since the total number of partons is different for different pieces
of the NLO calculation any explicit reference to a parton momentum
will lead to an inconsistent result.

@subsubsection Simple scale variations

@cindex FACTORIZATION_SCALE_FACTOR
@cindex RENORMALIZATION_SCALE_FACTOR
@anchor{FACTORIZATION_SCALE_FACTOR}
@anchor{RENORMALIZATION_SCALE_FACTOR}

Simple scale variations can be done using the following parameters:
@itemize
@item `FACTORIZATION_SCALE_FACTOR' specifies a global factor which the squared
factorisation scale (as specified above) is to be multiplied with when
evaluating PDFs.

Note: Shower starting scales are not affected by this factor, change the
`SCALES' parameter to achieve that.
@item `RENORMALIZATION_SCALE_FACTOR' specifies a global factor which the
squared renormalisation scale (as specified above) is to be multiplied with
when evaluating running couplings.

Note: This affects also the running coupling used in the parton shower evolution.
@end itemize

@node COUPLINGS
@subsection COUPLINGS
@cindex COUPLINGS
Within Sherpa, strong and electroweak couplings can be computed at any scale 
specified by a scale setter (cf. @ref{SCALES}). The @option{COUPLINGS} tag 
links the argument of a running coupling to one of the respective scales. 
This is better seen in an example. Assuming the following input
@verbatim
SCALES    VAR{...}{PPerp2(p[2])}{Abs2(p[2]+p[3])}
COUPLINGS Alpha_QCD 1, Alpha_QED 2
@end verbatim
Sherpa will compute any strong couplings at scale one, i.e. @samp{PPerp2(p[2])} 
and electroweak couplings at scale two, i.e. @samp{Abs2(p[2]+p[3])}.
Note that counting starts at zero.

@node KFACTOR
@subsection KFACTOR
@cindex KFACTOR
This parameter specifies how to evaluate potential K-factors in the hard
process. This is equivalent to the @option{COUPLINGS} specification of Sherpa
versions prior to 1.2.2. Currently available options are

@table @option
@item NO   
No reweighting
@item VAR
Couplings specified by an additional parameter in a form which is understood
by the internal interpreter, see @ref{Interpreter}. The tags @kbd{Alpha_QCD}
and @kbd{Alpha_QED} serve as links to the built-in running coupling implementation.

If for example the process @samp{g g -> h g} in effective theory is computed,
one could think of evaluating two powers of the strong coupling at the Higgs mass scale 
and one power at the transverse momentum squared of the gluon.
Assuming the Higgs mass to be 120 GeV, the corresponding reweighting would read
@verbatim
SCALES    VAR{...}{PPerp2(p[3])}
COUPLINGS Alpha_QCD 1
KFACTOR   VAR{sqr(Alpha_QCD(sqr(120))/Alpha_QCD(MU_12))}
@end verbatim
As can be seen from this example, scales are referred to as @kbd{MU_<i>2},
where @kbd{<i>} is replaced with the appropriate number. 
Note that counting starts at zero.
@end table

It is possible to implement a dedicated K-factor scheme within Sherpa.
For advice on this topic please contact the authors, @ref{Authors}.

@node YUKAWA_MASSES
@subsection YUKAWA_MASSES
@cindex YUKAWA_MASSES

This parameter specifies whether the Yukawa couplings are evaluated using
running or fixed quark masses: @code{YUKAWA_MASSES=Running} is the default since
version 1.2.2 while @code{YUKAWA_MASSES=Fixed} was the default until 1.2.1.

@node Dipole subtraction
@subsection Dipole subtraction
This list of parameters can be used to optimize the performance
when employing the Catani-Seymour dipole subtraction 
@mycite{Catani1996vz} as implemented in Amegic @mycite{Gleisberg2007md}.

@table @option
@item `DIPOLE_ALPHA' 
Specifies a dipole cutoff in the nonsingular region @mycite{Nagy2003tz}.
Changing this parameter shifts contributions from the subtracted real 
correction piece (RS) to the piece including integrated dipole terms (I), 
while their sum remains constant. This parameter can be used to optimize
the integration performance of the individual pieces. 
Also the average calculation time for the subtracted real correction
is reduced with smaller choices of `DIPOLE_ALPHA' due to the (on average)
reduced number of contributing dipole terms. For most processes
a reasonable choice is between 0.01 and 1 (default). See also
@ref{Choosing DIPOLE_ALPHA}
@item `DIPOLE_AMIN'
Specifies the cutoff of real correction terms in the infrared reagion
to avoid numerical problems with the subtraction. The default is 1.e-8.
@item `DIPOLE_NF_GSPLIT'
Specifies the number of quark flavours that are produced from 
gluon splittings. This number must be at least the number of massless 
flavours (default). If this number is larger than the number of massless
quarks the massive dipole subtraction @mycite{Catani2002hc} is employed.
@item `DIPOLE_KAPPA'
Specifies the kappa-parameter in the massive dipole subtraction formalism
@mycite{Catani2002hc}.
@end table
